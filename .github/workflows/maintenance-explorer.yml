name: Maintenance Explorer

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

concurrency:
  group: maintenance-explorer
  cancel-in-progress: false

jobs:
  explore:
    runs-on: ubuntu-latest
    continue-on-error: true
    timeout-minutes: 30
    permissions:
      contents: read
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Get recent issues for context
        id: context
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "### Recent Issues" >> $GITHUB_STEP_SUMMARY
          gh issue list --state all --limit 20 --json number,title,labels \
            -q '.[] | "- #\(.number): \(.title) [\(.labels|join(", "))]"' >> $GITHUB_STEP_SUMMARY || echo "No existing issues" >> $GITHUB_STEP_SUMMARY
          
          # Store for prompt injection
          ISSUES=$(gh issue list --state all --limit 20 -q '(.[] | "\(.title)") | join("|")')
          echo "recent_issues=$ISSUES" >> $GITHUB_OUTPUT

      - uses: anomalyco/opencode/github@v1
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          model: google/gemini-2.5-flash
          prompt: |
            You are a Code Health Explorer. Your job is to analyze the codebase for improvement opportunities.

            ## Project Context
            This is a CLI tool for analyzing GitHub development metrics. It uses Python 3.14, Typer for CLI, and Rich for terminal output. Follow the code style in AGENTS.md.

            ## Existing Issues (for deduplication)
            Recent issues already in the repo: ${{ steps.context.outputs.recent_issues }}
            Before creating a new issue, ensure it doesn't duplicate an existing one.

            ## Instructions

            Focus on static analysis only - don't run code or make assumptions about runtime behavior.

            1. **Code Health Analysis**: Look for:
               - Code that could be cleaner or more maintainable
               - Missing type hints on public APIs
               - Missing error handling
               - Inconsistent naming conventions
               - Code duplication
               - Missing or incomplete docstrings

            2. **Architecture Observations**: Note (but don't create issues for):
               - Architectural patterns used
               - Module organization
               - Dependencies

            3. **Security Review**: Flag potential security issues:
               - Hardcoded secrets/keys
               - Injection vulnerabilities
               - Insecure API usage

            4. **Prioritize**: Focus on high-impact issues that affect:
               - Code maintainability
               - Type safety
               - Error handling
               - Security

            5. **Create Issues**: For each high-priority finding, create a GitHub issue with:
               - Clear title describing the issue
               - Body: specific file and line reference, what's wrong, suggested fix
               - Label: `explorer:maintenance`
               - Assign severity: `critical`, `high`, `medium`, or `low`

            ## Output Format

            Create 3-5 issues maximum (focus on highest severity). For each:
            ```
            Title: [severity] [type]: Brief description
            Body:
            ## Severity
            critical / high / medium / low

            ## Location
            File:line or module

            ## Problem
            Describe what's wrong

            ## Suggested Fix
            How to fix it
            ```

            If no valuable issues found, respond with "NO_ISSUES_CREATED" and explain why.

            Write your findings summary to $GITHUB_STEP_SUMMARY as well.
