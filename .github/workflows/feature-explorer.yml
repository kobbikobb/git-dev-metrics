name: Feature Explorer

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

concurrency:
  group: feature-explorer
  cancel-in-progress: false

jobs:
  explore:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Get recent issues for context
        id: context
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Safe multi-line output for GitHub Actions
          echo "recent_issues<<EOF" >> $GITHUB_OUTPUT
          gh issue list --state all --limit 20 --json title -q '.[].title' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run OpenCode
        uses: anomalyco/opencode/github@v1
        env:
          GOOGLE_GENERATIVE_AI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          model: google/gemini-2.0-flash
          prompt: |
            You are a Feature Explorer. Analyze this repo (Python/Typer/Rich) and find gaps.
            
            Existing Issues:
            ${{ steps.context.outputs.recent_issues }}

            Output 1-3 high-value features as a JSON array in a file named 'features.json'.
            Each object MUST have "title" and "body" keys.
            Example: [{"title": "Add CSV Export", "body": "Allow users to export metrics."}]
            If no gaps found, output an empty array [].

      - name: Create GitHub Issues
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # If the AI created the JSON file, loop through it and post to GitHub
          if [ -f features.json ]; then
            jq -c '.[]' features.json | while read -r issue; do
              TITLE=$(echo "$issue" | jq -r '.title')
              BODY=$(echo "$issue" | jq -r '.body')
              gh issue create --title "$TITLE" --body "$BODY" --label "explorer:feature"
            done
          else
            echo "No features.json found."
          fi
